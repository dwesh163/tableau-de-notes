<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Prenom Nom Notes</title>

		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous" />

		<!-- <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous"> -->
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>

		<link rel="stylesheet" href="style.css" />
		<script src="script.js"></script>
	</head>
	<body class="gradient-custom vh-100 p-3">
		<div class="container">
			<section>
				<div class="bg-dark text-white" style="border-radius: 1rem">
					<div class="card-body p-5 text-center">
						<div class="mb-md-1 mt-md-1 pb-5 main">
							<div class="d-flex justify-content-between">
								<div class="d-flex">
									<h2 class="fw-bold text-uppercase" id="page" style="text-align: left; width: 100%"></h2>
									<input type="text" class="fw-bold text-uppercase form-control bg-dark text-white editbutton" id="editPageInput" aria-label="Sizing example input" aria-describedby="inputGroup-sizing-sm" autocomplete="off" />
								</div>
								<h2 class="fw-bold text-uppercase" id="username" style="text-align: left"></h2>
							</div>
							<hr />
							<br /><br />
							<div class="d-flex flex-wrap w-100" id="grades"></div>
						</div>
					</div>
					<div class="d-flex justify-content-between p-3">
						<a class="btn badge btn-primary d-inline-flex align-items-center" href="../" style="background-color: rgb(16, 146, 140); border: none">
							<svg xmlns="http://www.w3.org/2000/svg" width="32" height="30" fill="currentColor" class="bi bi-arrow-left-short" viewBox="0 0 16 16">
								<path fill-rule="evenodd" d="M12 8a.5.5 0 0 1-.5.5H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H11.5a.5.5 0 0 1 .5.5z" />
							</svg>
							Come Back
						</a>
						<div class="btn-group" id="btn-container" data-toggle="buttons"></div>
						<a class="btn badge btn-primary d-inline-flex align-items-center" style="background-color: rgb(16, 146, 140); border: none">
							<div id="validButton" onclick="setShowMode()">
								<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pencil" viewBox="0 0 16 16" style="margin-right: 5px">
									<path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207 11.207 2.5zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293l6.5-6.5zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325z" />
								</svg>
								valide
							</div>
							<div id="editButton" onclick="setEditMode()">
								<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pencil" viewBox="0 0 16 16" style="margin-right: 5px">
									<path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207 11.207 2.5zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293l6.5-6.5zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325z" />
								</svg>
								Edit
							</div>
						</a>
					</div>
				</div>
			</section>

			<div class="BeforeGrades">
				<div class="w-48">
					<div class="d-flex justify-content-center">
						<h4 class="mb-md-3 title">Semetre 1</h4>
						<input type="text" class="form-control bg-dark text-white brancheInput text-center newTitlenput" style="width: 100%" data-text="" data-number="" aria-label="Sizing example input" aria-describedby="" autocomplete="off" />
					</div>

					<table id="dtBasicExample" class="w-100 table table-responsive" cellspacing="0" style="border-bottom-width: 10px">
						<thead>
							<tr class="text-white">
								<th class="text-white">
									<h6 class="fw-bold">Branche</h6>
								</th>
								<th class="text-white" id="colspanGrade" colspan="3">
									<h6 class="fw-bold">Note</h6>
								</th>
								<th class="text-white">
									<h6 class="fw-bold">Moyenne</h6>
								</th>
							</tr>
						</thead>
						<tbody></tbody>
					</table>
				</div>
			</div>
		</div>

		<!-- Modal -->
		<div class="modal fade" id="modalAddPage" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content bg-dark">
					<div class="modal-header">
						<h1 class="modal-title fs-5 text-white" id="exampleModalLabel">Add page</h1>
						<button type="button" class="btn-close btn-close-white " data-bs-dismiss="modal" aria-label="Close" style="color: #fff"></button>
					</div>
					<div class="modal-body">
						<div class="input-group input-group-sm mb-3 bg-dark">
							<div class="input-group-prepend">
								<label class="input-group-text text-white" id="inputGroup-sizing-sm" for="addPageInput" style="background-color: rgb(78, 78, 78)">Page name :</label>
							</div>
							<input type="text" class="form-control bg-dark text-white" id="addPageInput" aria-label="Sizing example input" aria-describedby="inputGroup-sizing-sm" autocomplete="off" />
						</div>
					</div>
					<div class="modal-footer" style="border: none">
						<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
						<button type="button" class="btn btn-primary" onclick="SetNewPage()" style="background-color: rgb(16, 146, 140); border: none">Save changes</button>
					</div>
				</div>
			</div>
		</div>
	</body>

	<script>
		function getParameterByName(name, url) {
			if (!url) url = window.location.href;
			name = name.replace(/[\[\]]/g, '\\$&');
			var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
				results = regex.exec(url);
			if (!results) return null;
			if (!results[2]) return '';
			return decodeURIComponent(results[2].replace(/\+/g, ' '));
		}

		username = getParameterByName('name');
		console.log(username);

		$('#username').text(getParameterByName('name').replace('.', ' '));

		if (getParameterByName('p') == null) {
			console.log(JSON.parse(localStorage.getItem('data')));
			page = JSON.parse(localStorage.getItem('data'))[username]['page'][0];
			console.log(page);
			console.log(localStorage.getItem('data'));
			window.location.href = `?name=${username}&p=${page}`;
		}

		$('#page').text(getParameterByName('p').replace('.', ' '));

		$(document).prop('title', 'New Title');

		document.title = `Grade of ${getParameterByName('name').replace('.', ' ')}`;
	</script>

	<script>
		function getAverage(numbers) {
			numbers.shift();

			return Math.round(numAverage(numbers) * 2) / 2;
		}

		function numAverage(a, f) {
			f =
				f ||
				function (n) {
					return n;
				};
			var b = a.length,
				c = 0,
				i;
			for (i = 0; i < b; i++) {
				c += Number(f(a[i]));
			}
			return c / b;
		}
	</script>

	<script>
		$('.BeforeGrades').hide();

		let grades = $('#grades');
		let tbody = $('tbody');
		let nextgrades = '';
		let dataGrades = JSON.parse(localStorage.getItem('data'))[getParameterByName('name')][getParameterByName('p')];

		for (let i = 0; i < Object.keys(dataGrades).length; i++) {
			if (dataGrades != null) {
				clonedtable = $('.BeforeGrades').clone();
				let varTr = '';
				let varLenght = 0;

				for (let index = 1; index < Object.keys(dataGrades[i]).length; index++) {
					if (Object.keys(dataGrades[i][index]).length > varLenght) {
						varLenght = Object.keys(dataGrades[i][index]).length;
					}
				}

				varLenght += 1;

				for (let Branche = 1; Branche < Object.keys(dataGrades[i]).length; Branche++) {
					varTr += `<tr class="text-white"><td  style="width: 200px;">
						<div class="d-flex justify-content-center" >
									<span class="hideEdit brancheText">${dataGrades[i][Branche][0].replace('_', ' ')}</span>
									<input type="text" class="form-control bg-dark text-white brancheInput text-center" style="width: 100%;" data-text=${dataGrades[i][Branche][0]} aria-label="Sizing example input" aria-describedby="" autocomplete="off" />
								</div>
						</td>`;

					for (let grade = 1; grade < Object.keys(dataGrades[i][Branche]).length; grade++) {
						varTr += `<td class="border-1">${dataGrades[i][Branche][grade]}</td>`;
					}

					for (let space = 0; space < varLenght - Object.keys(dataGrades[i][Branche]).length - 1; space++) {
						varTr += `<td class="border-1"></td>`;
					}

					varTr += `<td>${getAverage(dataGrades[i][Branche])}</td>`;
					varTr += `<td class="border-0">
					<div class="editbutton btn btn-secondary badge" style="width: 32px; height: 30px;">
										<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pencil" viewBox="0 0 16 16">
											<path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207 11.207 2.5zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293l6.5-6.5zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325z" />
										</svg>
									</div></td>`;
					varTr += '</tr>';
				}

				varTr += `<tr>
							<td class="border-0">
								<input type="text" class="form-control bg-dark text-white brancheInput newBrancheInput" style="width: 100%;" data-text="" data-number="${i}" aria-label="Sizing example input" aria-describedby="" autocomplete="off" />
							</td>
						</tr>`;

				$('tbody').html(varTr);

				var clonedtable = $('.BeforeGrades').clone();

				clonedtable.find('.title').text(dataGrades[i][0]);
				clonedtable.find('.newTitlenput').attr("data-text", dataGrades[i][0]);
				clonedtable.find('.newTitlenput').attr('data-number', i);
				clonedtable.find('#colspanGrade').attr('colspan', varLenght - 2);

				nextgrades += clonedtable.html();
			}
		}

		grades.html(nextgrades);
	</script>

	<script>
		$('.templateButton').hide();

		let templatButton = `<div>
                <label class="btn btn-secondary" >
                    <a href="" class="text-white text-uppercase badge" style="text-decoration:none; "></a>
                </label>
            </div>`;

		let templatButtonPlus = `<a type="button" data-bs-toggle="modal" data-bs-target="#modalAddPage" class="btn btn-secondary">
							<svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 448 512">
								<!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. -->
								<style>
									svg {
										fill: #ffffff;
									}
								</style>
								<path d="M256 80c0-17.7-14.3-32-32-32s-32 14.3-32 32V224H48c-17.7 0-32 14.3-32 32s14.3 32 32 32H192V432c0 17.7 14.3 32 32 32s32-14.3 32-32V288H400c17.7 0 32-14.3 32-32s-14.3-32-32-32H256V80z" />
							</svg>
						</a>`;

		HTMLButton = $('<div></div>').html(templatButton).children();

		let dataButton = JSON.parse(localStorage.getItem('data'))[getParameterByName('name')]['page'];
		let nextButton = '';
		let containerButton = $('#btn-container');

		for (let i = 0; i < Object.keys(dataButton).length; i++) {
			let clonedbutton = HTMLButton;

			clonedbutton.find('a').text(dataButton[i]);
			clonedbutton.find('a').attr('href', `?name=${getParameterByName('name')}&p=${dataButton[i]}`);
			clonedbutton.find('.btn').removeClass('active');

			if (clonedbutton.children().text().trim() == getParameterByName('p')) {
				clonedbutton.find('.btn').addClass('active');
			}

			nextButton += clonedbutton.html();
		}

		nextButton += templatButtonPlus;
		containerButton.html(nextButton);
	</script>

	<script>
		const cells = document.querySelectorAll('.border-1');

		cells.forEach((cell) => {
			const value = parseFloat(cell.textContent);

			if (value >= 1) {
				cell.classList.add('red');
			}
			if (value >= 4) {
				cell.classList.add('orange');
			}
			if (value >= 5) {
				cell.classList.add('green');
			}
		});
	</script>

	<script>
		data = JSON.parse(localStorage.getItem('data'));
		function SetNewPage() {
			data[getParameterByName('name')]['page'].push($('#addPageInput').val());
			localStorage.setItem('data', JSON.stringify(data));
			location.reload();
		}

		$('.editbutton').hide();
		$('#validButton').hide();
		$('#editButton').show();
		$('#page').show();
		$('.hideEdit').show();
		$('.brancheInput').hide();
		$('.title').show();

		function setEditMode() {
			$('.editbutton').show();
			$('#validButton').show();
			$('#editButton').hide();
			$('#page').hide();
			$('.hideEdit').hide();
			$('#editPageInput').val(getParameterByName('p'));
			$('.brancheInput').show();
			$('.title').hide();

			$('.brancheInput').each(function () {
				$(this).val($(this).attr('data-text').replace('_', ' '));
			});

			$('.title').each(function () {
				$(this).val($(this).attr('data-text').replace('_', ' '));
			});
		}

		function setShowMode() {
			console.log($('#editPageInput').val());
			data = JSON.parse(localStorage.getItem('data'));

			if ($('#editPageInput').val() != getParameterByName('p')) {
				newData = [];

				newData.push($('#editPageInput').val());
				newData.push(...data[getParameterByName('name')]['page']);

				data[getParameterByName('name')]['page'] = newData.filter((page) => page !== getParameterByName('p'));
				data[getParameterByName('name')][$('#editPageInput').val()] = data[getParameterByName('name')][getParameterByName('p')];
				data[getParameterByName('name')][getParameterByName('p')] = {};
			}

			$('.brancheInput').each(function () {
				for (let i = 0; i <= data[getParameterByName('name')][getParameterByName('p')].length - 1; i++) {
					for (let j = 1; j < data[getParameterByName('name')][getParameterByName('p')][i].length; j++) {
						if (data[getParameterByName('name')][getParameterByName('p')][i][j][0] == $(this).attr('data-text')) {
							data[getParameterByName('name')][getParameterByName('p')][i][j][0] = $(this).val().replace(' ', '_');
							console.log(data[getParameterByName('name')][getParameterByName('p')][i][j][0], $(this).val());
						}
					}
				}
			});

			$('.newBrancheInput').each(function () {
				if ($(this).val() != '') {
					data[getParameterByName('name')][getParameterByName('p')][$(this).attr('data-number')].push([$(this).val()]);
				}
			});

			$('.newTitlenput').each(function () {
				console.log()
				if ($(this).val() != '' && $(this).attr('data-number')) {
					data[getParameterByName('name')][getParameterByName('p')][$(this).attr('data-number')][0] = $(this).val();
				}
			});

			localStorage.setItem('data', JSON.stringify(data));
			window.location.href = `?name=${getParameterByName('name')}&p=${$('#editPageInput').val()}`;
		}
	</script>
</html>
