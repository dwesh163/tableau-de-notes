<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=, initial-scale=1.0" />
		<!-- Font Awesome -->
		<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
		<!-- Google Fonts -->
		<link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" rel="stylesheet" />
		<!-- MDB -->
		<link href="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/6.4.2/mdb.min.css" rel="stylesheet" />

		<link rel="stylesheet" href="style.css" />
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
		<title>Sign Up</title>
	</head>
	<body>
		<form action="" , id="loginForm">
			<section class="vh-100 gradient-custom">
				<div class="container py-5 h-100">
					<div class="row d-flex justify-content-center align-items-center h-100">
						<div class="col-12 col-md-8 col-lg-6 col-xl-5">
							<div class="card bg-dark text-white" style="border-radius: 1rem">
								<div class="card-body p-5 text-center">
									<div class="mb-md-5 mt-md-4 pb-5">
										<h2 class="fw-bold mb-1 text-uppercase">Sign up</h2>
										<hr />
										<div class="form-outline form-white mb-3 typeLinkClass">
											<input type="link" id="typeLinkX" class="form-control form-control-lg" autocomplete="off" />
											<label class="form-label" for="typeLinkX" style="margin-left: 0px">Github Link</label>
											<div class="form-notch">
												<div class="form-notch-leading" style="width: 9px"></div>
												<div class="form-notch-middle" style="width: 70px"></div>
												<div class="form-notch-trailing"></div>
											</div>
										</div>
										<div class="form-outline form-white mb-3 typeNameClass">
											<input type="text" id="typeNameX" class="form-control form-control-lg" autocomplete="off" />
											<label class="form-label" for="typeNameX" style="margin-left: 0px">First Name</label>
											<div class="form-notch">
												<div class="form-notch-leading" style="width: 9px"></div>
												<div class="form-notch-middle" style="width: 74px"></div>
												<div class="form-notch-trailing"></div>
											</div>
										</div>
										<div class="form-outline form-white mb-3 typeLastNameClass">
											<input type="text" id="typeLastNameX" class="form-control form-control-lg" autocomplete="off" />
											<label class="form-label" for="typeLastNameX" style="margin-left: 0px">Last name</label>
											<div class="form-notch">
												<div class="form-notch-leading" style="width: 9px"></div>
												<div class="form-notch-middle" style="width: 73px"></div>
												<div class="form-notch-trailing"></div>
											</div>
										</div>
										<br />

										<div class="mb-3">
											<input class="form-check-input" type="checkbox" value="" id="flexCheckChecked" />
											<label class="form-check-label" for="flexCheckChecked"> Use a Github Repository </label>
										</div>

										<button class="btn btn-outline-light btn-lg px-5" type="submit">Add Link</button>
									</div>
									<div>
										<p class="mb-0">Come back ? <a href="../" class="text-white-50">Click here</a></p>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</section>
		</form>
	</body>

	<script>
		$('.typeLinkClass').hide();
		$(document).ready(function () {
			$('input[type="checkbox"]').click(function () {
				if ($(this).prop('checked') == true) {
					$('.typeNameClass').hide();
					$('.typeLastNameClass').hide();
					$('.typeLinkClass').show();
				} else if ($(this).prop('checked') == false) {
					$('.typeNameClass').show();
					$('.typeLastNameClass').show();
					$('.typeLinkClass').hide();
				}
			});
		});
	</script>

	<script>
		async function fetchAPI2(url) {
			console.log('COUCOU');
			console.log(url);

			try {
				let response = await fetch(url);
				console.log('res', response);

				if (response.ok) {
					const data = await response.json();
					return data;
				} else {
					console.error('Network response was not ok.');
				}
			} catch (error) {
				console.error('An error occurred:', error);
			}
		}
		async function init_from_url(json_data_url) {
			console.log(json_data_url);
			if (!json_data_url.includes('https://')) {
				json_data_url = 'https://' + json_data_url;
			}
			let json_url = json_data_url.replace('https://github.com/', 'https://raw.githubusercontent.com/').replace('blob/', '');
			let data = await fetchAPI2(json_url);
			//console.log(link.replace('https://github.com/', 'https://raw.githubusercontent.com/').replace('blob/', ''))
			localData = localStorage.getItem('data');

			if (localData == null) {
				localData = {};
			}

			for (var person in data) {
				console.log(person);
				localData[person] = data[person];
				data[person]['url'] = json_url;
			}

			//console.log(localData)

			localStorage.setItem('data', JSON.stringify(localData));
		}

		const loginForm = document.getElementById('loginForm');

		loginForm.addEventListener('submit', function (e) {
			e.preventDefault();

			let json_data_url = document.getElementById('typeLinkX').value;
			const name = strUcFirst(document.getElementById('typeNameX').value).trim();
			const lastName = strUcFirst(document.getElementById('typeLastNameX').value).trim();

			if (json_data_url == '') {
				console.log(name, lastName);
				data = JSON.parse(localStorage.getItem('data'));

				if (data == null) {
					data = {};
				}
				if (`${name}.${lastName}` in data) {
					alert('il y a deja un compte avec ces informations');
				} else {
					dataObjet = {
						name: name,
						lastname: lastName,
						type: 'local',
						modified: new Date().toLocaleDateString('fr-FR'),
					};

					data[`${name}-${lastName}`] = dataObjet;
					localStorage.setItem('data', JSON.stringify(data));

					window.location.href = '../';
				}
			} else {
				init_from_url(json_data_url);
				window.location.href = '../';
			}
		});

		function strUcFirst(a) {
			return (a + '').charAt(0).toUpperCase() + (a + '').substr(1);
		}

		/**
		 * Functions to prevent form's group label to stay in the input
		 */
		$('#typeNameX').on('input', function () {
			if ($(this).val()) {
				$(this).addClass('active');
			} else {
				$(this).removeClass('active');
			}
		});
		$('#typeLastNameX').on('input', function () {
			if ($(this).val()) {
				$(this).addClass('active');
			} else {
				$(this).removeClass('active');
			}
		});
		$('#typeLinkX').on('input', function () {
			if ($(this).val()) {
				$(this).addClass('active');
			} else {
				$(this).removeClass('active');
			}
		});

	</script>
</html>
